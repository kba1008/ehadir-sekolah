<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Kehadiran Korporat</title>
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; }
        .hidden-el { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Corporate Shadow */
        .corp-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }

        /* Modal Image Zoom */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex justify-center items-center p-0 sm:p-4 bg-slate-200" oncontextmenu="return false;">

    <!-- Warning Box (GPS) -->
    <div id="warningBox" class="fixed top-0 left-0 w-full bg-red-700 text-white p-3 text-center text-sm font-semibold z-50 hidden-el shadow-md tracking-wide">
        <i class="fa-solid fa-circle-exclamation mr-2"></i> PERHATIAN: SILA KEMBALI KE ZON LOKASI
    </div>

    <!-- Image Modal (Popup Gambar) -->
    <div id="imageModal" class="fixed inset-0 z-[100] modal-backdrop hidden-el flex items-center justify-center p-4 fade-in" onclick="closeImage()">
        <div class="relative max-w-full max-h-full">
            <img id="fullScreenImage" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl border-2 border-slate-700 object-contain">
            <button onclick="closeImage()" class="absolute -top-10 right-0 text-white text-xl font-bold bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center border border-slate-600">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <p class="text-center text-white text-xs mt-2 font-mono">Ketuk mana-mana untuk tutup</p>
        </div>
    </div>

    <div class="w-full max-w-md bg-white sm:rounded-xl shadow-2xl overflow-hidden relative min-h-screen sm:min-h-0 flex flex-col">
        
        <!-- Corporate Header -->
        <div class="bg-slate-900 text-white px-6 py-8 relative z-10">
            <div id="connectionStatus" class="absolute top-2 right-2 text-[9px] font-mono opacity-50 hidden-el">GPS ACTIVE</div>
            
            <div class="flex justify-between items-center border-b border-slate-700 pb-4 mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-building-user text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight uppercase">E-HADIR PRO</h1>
                        <h2 id="schoolTitle" class="text-[10px] text-slate-400 font-medium tracking-widest uppercase">PENGURUSAN STAF</h2>
                    </div>
                </div>
                <div class="text-right">
                    <div id="clockDisplay" class="text-xl font-bold font-mono tracking-tighter">--:--</div>
                    <div id="dateDisplay" class="text-[10px] text-slate-400 uppercase">--/--/--</div>
                </div>
            </div>

            <div class="flex justify-between items-center text-xs">
                <span id="hijriDisplay" class="text-slate-300 font-light"><i class="fa-regular fa-calendar mr-1"></i> ...</span>
                <span id="statusText" class="font-semibold bg-slate-800 px-3 py-1 rounded-full border border-slate-700 text-slate-400">
                    <i class="fa-solid fa-spinner fa-spin mr-1"></i> Mengesan GPS...
                </span>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="p-6 flex-grow bg-slate-50 relative">
            
            <!-- Background Decoration -->
            <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-slate-100 to-transparent pointer-events-none"></div>

            <!-- DASHBOARD PANEL (User logged in) -->
            <div id="dashboardPanel" class="hidden-el fade-in relative z-10">
                <!-- ID Card Style -->
                <div class="bg-white border-l-4 border-blue-600 rounded-lg p-5 mb-6 corp-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">LOG MASUK SEBAGAI</p>
                            <h3 id="sessionName" class="text-xl font-bold text-slate-800 leading-tight uppercase">--</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                            <i class="fa-solid fa-user-tie"></i>
                        </div>
                    </div>
                    <div class="bg-blue-50 text-blue-800 px-3 py-2 rounded text-xs font-bold text-center border border-blue-100">
                        STATUS: SEDANG BERTUGAS
                    </div>
                </div>

                <div id="earlyExitWarning" class="hidden-el mb-2 text-[10px] text-red-600 font-bold uppercase tracking-wide flex items-center">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> Anda pulang lebih awal dari jadual
                </div>
                <textarea id="alasanKeluar" class="w-full p-3 text-sm border border-red-200 bg-red-50 rounded-lg mb-4 focus:outline-none focus:ring-1 focus:ring-red-500 hidden-el resize-none" rows="2" placeholder="Sila nyatakan sebab pulang awal..."></textarea>
                
                <button id="btnKeluar" onclick="hantarKeluar()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-medium py-3 rounded-lg shadow-md transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Daftar Keluar
                </button>

                <div class="my-6 border-t border-slate-200 relative">
                    <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-slate-50 px-2 text-[10px] text-slate-400 uppercase">Menu Tambahan</span>
                </div>

                <button onclick="showPelawatForm()" class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 font-semibold py-3 rounded-lg transition active:scale-[0.98] flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-user-plus"></i> Daftar Pelawat
                </button>
            </div>

            <!-- LOGIN FORM (Default) -->
            <div id="defaultForm" class="fade-in relative z-10">
                <div class="space-y-5">
                    
                    <!-- NOTE BARU: Info Kategori -->
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 flex items-start gap-3 shadow-sm">
                        <i class="fa-solid fa-circle-info text-blue-600 mt-0.5 text-xs"></i>
                        <div>
                            <p class="text-[10px] text-blue-800 font-bold uppercase leading-tight">PERHATIAN</p>
                            <p class="text-[10px] text-slate-600 leading-tight">Sila pilih kategori pekerjaan anda untuk melihat waktu bekerja yang telah ditetapkan dalam sistem.</p>
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Kategori Pengguna</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                <i class="fa-solid fa-layer-group text-sm"></i>
                            </div>
                            <!-- Added updateTimeDisplay() to onchange -->
                            <select id="kategori" onchange="checkKategori(); triggerAlasanMasuk(); updateTimeDisplay();" class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg bg-white focus:outline-none focus:border-blue-600 focus:ring-1 focus:ring-blue-600 text-sm font-medium appearance-none transition-colors">
                                <option value="" disabled selected>Pilih Kategori</option>
                                <option value="GURU">GURU</option>
                                <option value="AKP">AKP</option>
                                <option value="KEBERSIHAN">PEKERJA KEBERSIHAN</option>
                                <option value="PELAWAT">PELAWAT LUAR</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-slate-400">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>

                        <!-- BARU: Paparan Masa Bekerja -->
                        <div id="workingHoursDisplay" class="hidden-el mt-2 bg-slate-800 text-white p-3 rounded-lg border border-slate-700 shadow-sm text-center">
                            <p class="text-[9px] text-slate-400 uppercase tracking-widest mb-1">Waktu Bekerja Ditetapkan</p>
                            <div class="flex justify-center items-center gap-4 text-xs font-mono font-bold">
                                <span class="text-emerald-400"><i class="fa-solid fa-right-to-bracket mr-1"></i><span id="timeIn">--:--</span></span>
                                <span class="text-slate-500">|</span>
                                <span class="text-rose-400"><i class="fa-solid fa-right-from-bracket mr-1"></i><span id="timeOut">--:--</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Nama Penuh</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                <i class="fa-solid fa-id-card text-sm"></i>
                            </div>
                            <input type="text" id="nama" placeholder="Taip nama penuh..." class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-600 focus:ring-1 focus:ring-blue-600 text-sm font-semibold uppercase transition-colors">
                        </div>
                    </div>

                    <div id="lateEntryWarning" class="hidden-el mb-1 text-[10px] text-amber-600 font-bold uppercase tracking-wide flex items-center">
                        <i class="fa-solid fa-clock-rotate-left mr-1"></i> Anda mendaftar lewat dari jadual
                    </div>
                    <textarea id="alasanMasuk" class="w-full p-3 text-sm border border-amber-300 bg-amber-50 rounded-lg hidden-el focus:outline-none focus:ring-1 focus:ring-amber-500 resize-none" rows="2" placeholder="Sila nyatakan sebab kelewatan..."></textarea>

                    <button id="btnMainSubmit" onclick="hantarMasuk()" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3.5 rounded-lg shadow-lg shadow-blue-900/20 transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-sm uppercase tracking-wide mt-4">
                        <i class="fa-solid fa-fingerprint text-lg"></i> Sahkan Kehadiran
                    </button>
                </div>
            </div>

            <!-- PELAWAT PANEL -->
            <div id="pelawatPanel" class="hidden-el fade-in bg-white p-5 rounded-lg border border-slate-200 shadow-sm relative z-10">
                <div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-2">
                    <div class="w-8 h-8 rounded bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-camera"></i></div>
                    <h3 class="text-slate-700 font-bold text-sm uppercase">Rekod Pelawat</h3>
                </div>
                
                <div class="space-y-3">
                    <input type="text" id="tujuan" placeholder="TUJUAN / NO. KENDERAAN" class="w-full p-3 border border-slate-300 rounded-lg uppercase text-xs font-semibold focus:outline-none focus:border-blue-500">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <label class="bg-slate-800 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-slate-700 transition">
                            <i class="fa-solid fa-camera block text-lg mb-1"></i>
                            <span class="text-[10px] font-bold uppercase tracking-wide">Kamera Belakang</span>
                            <input type="file" accept="image/*" capture="environment" class="hidden" onchange="processImage(this)">
                        </label>
                        <label class="bg-slate-600 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-slate-500 transition">
                            <i class="fa-solid fa-camera-rotate block text-lg mb-1"></i>
                            <span class="text-[10px] font-bold uppercase tracking-wide">Kamera Depan</span>
                            <input type="file" accept="image/*" capture="user" class="hidden" onchange="processImage(this)">
                        </label>
                    </div>

                    <div class="relative w-full rounded-lg overflow-hidden border border-slate-300 bg-slate-100 min-h-[120px]">
                        <img id="previewImg" class="w-full object-cover hidden-el">
                        <div id="placeholderCam" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                            <i class="fa-regular fa-image text-2xl mb-1"></i>
                            <span class="text-[10px]">Pratonton Foto</span>
                        </div>
                    </div>
                    
                    <input type="hidden" id="base64Foto">
                    
                    <div class="flex gap-3 pt-2">
                        <button onclick="cancelPelawat()" class="flex-1 bg-white border border-slate-300 text-slate-600 font-bold py-2.5 rounded-lg text-xs hover:bg-slate-50">BATAL</button>
                        <button id="btnPelawatSubmit" onclick="hantarPelawat()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg text-xs shadow">HANTAR</button>
                    </div>
                </div>
            </div>

            <!-- LIST SECTION -->
            <div class="mt-10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 text-xs uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-blue-600"></i> Log Hari Ini
                    </h3>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] bg-slate-200 px-2 py-1 rounded text-slate-600 font-bold">Total: <span id="count">0</span></span>
                        <button onclick="loadList()" class="w-6 h-6 rounded bg-white border border-slate-200 text-slate-500 hover:text-blue-600 flex items-center justify-center transition">
                            <i class="fa-solid fa-rotate text-xs"></i>
                        </button>
                    </div>
                </div>
                
                <div id="listContainer" class="space-y-2 max-h-[400px] overflow-y-auto pr-1 custom-scrollbar pb-6">
                    <div class="text-center py-6 text-slate-400 text-xs italic">Memuatkan data...</div>
                </div>
            </div>
            
            <div class="text-center mt-8 pb-4">
                 <p class="text-[9px] text-slate-300 cursor-pointer hover:text-slate-400 transition font-mono" onclick="resetSesi()">SYSTEM ID: 2023-CORP-V2</p>
            </div>
        </div>
    </div>

<script>
    // KONFIGURASI SISTEM
    const API_URL = 'https://script.google.com/macros/s/AKfycbxnengUIJ3-_rPCiZWDtlrYSOr68pSpSlEabeXxEBw-xTHVye2cEkMaWfobVeLoJIGL/exec'; 
    const PASSCODE = "101010";
    const SCHOOL_LAT = 5.227932478937475; 
    const SCHOOL_LNG = 100.69901604319402; 
    const RADIUS_METER = 1000; 

    // Konfigurasi Jadual Asas (Fallback berdasarkan gambar JAM)
    let jamConfig = {
        "GURU": { masuk: "7:50:00 AM", keluar: "1:30:00 PM" },
        "AKP": { masuk: "8:15:00 AM", keluar: "4:00:00 PM" },
        "KEBERSIHAN": { masuk: "7:30:00 AM", keluar: "4:00:00 PM" }, // Dianggap PM walaupun gambar tulis AM (typo biasa)
        "PELAWAT": { masuk: "BEBAS", keluar: "BEBAS" }
    };

    let isInZone = false; 
    let lastLat = 0, lastLng = 0;

    window.onload = function() {
        startClock();
        startRadar();
        checkSession();
        loadList();
        fetchConfig(); // Cuba tarik config terkini dari server
        getHijriDate();
        setInterval(triggerAlasanKeluar, 5000);
        setInterval(loadList, 60000);
    };

    function fetchConfig() {
        fetch(API_URL, { method: "POST", body: JSON.stringify({action: "GET_CONFIG", passcode: PASSCODE}) })
        .then(r => r.json()).then(res => { 
            if(res.status === "SUCCESS") {
                // Merge data server dengan data sedia ada
                jamConfig = {...jamConfig, ...res.data};
                // Update paparan jika pengguna sudah memilih kategori sebelum data sampai
                updateTimeDisplay();
            }
        });
    }

    // FUNGSI BARU: Paparkan Waktu Kerja
    function updateTimeDisplay() {
        let kat = document.getElementById('kategori').value;
        let displayBox = document.getElementById('workingHoursDisplay');
        let timeInEl = document.getElementById('timeIn');
        let timeOutEl = document.getElementById('timeOut');

        if (kat && kat !== "PELAWAT" && jamConfig[kat]) {
            timeInEl.innerText = jamConfig[kat].masuk;
            timeOutEl.innerText = jamConfig[kat].keluar;
            displayBox.classList.remove('hidden-el');
            displayBox.classList.add('fade-in');
        } else {
            displayBox.classList.add('hidden-el');
        }
    }

    function triggerAlasanMasuk() {
        let kat = document.getElementById('kategori').value;
        let area = document.getElementById('alasanMasuk');
        let warn = document.getElementById('lateEntryWarning');
        let now = new Date();

        if (kat && kat !== "PELAWAT" && jamConfig[kat]) {
            let limitMasuk = parseTime(jamConfig[kat].masuk, now);
            // Jika masuk lebih masa yang ditetapkan
            if (limitMasuk && now > limitMasuk) {
                area.classList.remove('hidden-el');
                warn.classList.remove('hidden-el');
                return;
            }
        }
        area.classList.add('hidden-el');
        warn.classList.add('hidden-el');
    }

    function triggerAlasanKeluar() {
        let s = JSON.parse(localStorage.getItem('ehadir_session'));
        let area = document.getElementById('alasanKeluar');
        let warn = document.getElementById('earlyExitWarning');
        
        if (s && jamConfig[s.kategori]) {
            let limitKeluar = parseTime(jamConfig[s.kategori].keluar, new Date());
            // Jika keluar sebelum masa yang ditetapkan
            if (limitKeluar && new Date() < limitKeluar) {
                area.classList.remove('hidden-el');
                warn.classList.remove('hidden-el');
            } else {
                area.classList.add('hidden-el');
                warn.classList.add('hidden-el');
            }
        }
    }

    function hantarMasuk() {
        if(!isInZone) { alert("â›” AKSES DITOLAK: ANDA DI LUAR KAWASAN PREMIS!"); return; }
        let nama = document.getElementById('nama').value.toUpperCase().trim();
        let kat = document.getElementById('kategori').value;
        let alasan = document.getElementById('alasanMasuk').value;
        let now = new Date();

        if (!nama || !kat) { alert("Sila lengkapkan butiran Nama & Kategori."); return; }
        
        // Validasi Alasan
        if (!document.getElementById('alasanMasuk').classList.contains('hidden-el') && alasan.trim() === "") {
            alert("Sila nyatakan alasan kelewatan anda."); return;
        }

        let btn = document.getElementById('btnMainSubmit');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> MEMPROSES...';

        sendData({ action: "MASUK", passcode: PASSCODE, nama: nama, kategori: kat, alasan: alasan, lat: lastLat, lng: lastLng, clientTime: now.toISOString() }, () => {
            localStorage.setItem('ehadir_session', JSON.stringify({nama: nama, kategori: kat, date: now.toISOString().slice(0,10)}));
            location.reload();
        });
    }

    function hantarKeluar() {
        let session = JSON.parse(localStorage.getItem('ehadir_session'));
        let alasan = document.getElementById('alasanKeluar').value;
        
        if (!document.getElementById('alasanKeluar').classList.contains('hidden-el') && alasan.trim() === "") {
            alert("Sila nyatakan alasan pulang awal."); return;
        }

        if(!confirm("Sahkan daftar keluar?")) return;
        let btn = document.getElementById('btnKeluar');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> MEMPROSES...';

        sendData({ action: "KELUAR", passcode: PASSCODE, nama: session.nama, alasan: alasan, lat: lastLat, lng: lastLng, clientTime: new Date().toISOString() }, () => {
            localStorage.removeItem('ehadir_session');
            location.reload();
        });
    }

    function forceCheckoutPelawat(nama) {
        if(!confirm("Daftar keluar pelawat ini (" + nama + ")?")) return;
        document.getElementById('listContainer').innerHTML = '<div class="text-center py-4 text-slate-400"><i class="fa-solid fa-circle-notch fa-spin"></i> Memproses...</div>';
        sendData({ action: "KELUAR", passcode: PASSCODE, nama: nama, alasan: "PELAWAT CHECKOUT", lat: lastLat, lng: lastLng, clientTime: new Date().toISOString() }, () => {
            loadList();
        });
    }

    function hantarPelawat() {
        let foto = document.getElementById('base64Foto').value;
        let tjn = document.getElementById('tujuan').value.toUpperCase();
        if (!foto || !tjn) { alert("Sila ambil gambar & isi tujuan."); return; }
        
        let btn = document.getElementById('btnPelawatSubmit');
        btn.disabled = true;
        btn.innerText = '...';

        sendData({ action: "MASUK", passcode: PASSCODE, kategori: "PELAWAT", nama: tjn, fotoBase64: foto, lat: lastLat, lng: lastLng }, () => location.reload());
    }

    function sendData(p, cb) { fetch(API_URL, { method: "POST", body: JSON.stringify(p) }).then(() => cb()).catch(() => { alert("Ralat sambungan pelayan."); cb(); }); }

    function parseTime(t, r) {
        if (!t || t === "BEBAS") return null;
        let d = new Date(r), p = t.match(/(\d+)[.:](\d+).*?(AM|PM)/i);
        if(p) {
            let h = parseInt(p[1]), m = parseInt(p[2]);
            let ampm = p[3].toUpperCase();
            if(ampm === "PM" && h < 12) h += 12;
            if(ampm === "AM" && h === 12) h = 0;
            d.setHours(h, m, 0, 0); return d;
        } return null;
    }

    function calcDuration(timeStr) {
        if (!timeStr) return "-";
        let now = new Date();
        let entry = new Date();
        let parts = timeStr.match(/(\d+):(\d+)/);
        if (!parts) return "-";
        let h = parseInt(parts[1]);
        let m = parseInt(parts[2]);
        if (timeStr.toUpperCase().includes('PM') && h < 12) h += 12;
        if (timeStr.toUpperCase().includes('AM') && h === 12) h = 0;
        entry.setHours(h, m, 0, 0);
        if (entry > now) return "Baru masuk";
        let diffMs = now - entry;
        let diffHrs = Math.floor(diffMs / 3600000);
        let diffMins = Math.floor((diffMs % 3600000) / 60000);
        if (diffHrs > 0) return `${diffHrs}j ${diffMins}m`;
        return `${diffMins}m`;
    }

    function showImage(url) {
        if(!url) return;
        document.getElementById('fullScreenImage').src = url;
        document.getElementById('imageModal').classList.remove('hidden-el');
    }

    function closeImage() {
        document.getElementById('imageModal').classList.add('hidden-el');
        document.getElementById('fullScreenImage').src = "";
    }

    function startRadar() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                lastLat = pos.coords.latitude; lastLng = pos.coords.longitude;
                let dist = calcDist(lastLat, lastLng, SCHOOL_LAT, SCHOOL_LNG);
                isInZone = (dist <= RADIUS_METER);
                let statusBadge = document.getElementById('statusText');
                let warnBox = document.getElementById('warningBox');
                
                if(isInZone){
                    statusBadge.innerHTML = '<i class="fa-solid fa-wifi text-emerald-400"></i> GPS: OK';
                    statusBadge.className = "font-bold bg-slate-800 px-3 py-1 rounded-full border border-emerald-900 text-emerald-400 text-[10px] tracking-wide";
                    warnBox.classList.add('hidden-el');
                } else {
                    statusBadge.innerHTML = `<i class="fa-solid fa-location-slash text-red-400"></i> LUAR: ${Math.round(dist)}m`;
                    statusBadge.className = "font-bold bg-slate-800 px-3 py-1 rounded-full border border-red-900 text-red-400 text-[10px] tracking-wide";
                    warnBox.classList.remove('hidden-el');
                }
            }, null, {enableHighAccuracy: true});
        }
    }

    function calcDist(a,b,c,d){var R=6371e3,x=a*Math.PI/180,y=c*Math.PI/180,k=(c-a)*Math.PI/180,l=(d-b)*Math.PI/180,z=Math.sin(k/2)*Math.sin(k/2)+Math.cos(x)*Math.cos(y)*Math.sin(l/2)*Math.sin(l/2);return R*2*Math.atan2(Math.sqrt(z),Math.sqrt(1-z));}
    function startClock(){setInterval(()=>{let n=new Date();document.getElementById('clockDisplay').innerText=n.toLocaleTimeString('en-US',{hour12:true,hour:"2-digit",minute:"2-digit"});document.getElementById('dateDisplay').innerText=n.toLocaleDateString('ms-MY');},1000);}
    
    function checkSession() { 
        let s = JSON.parse(localStorage.getItem('ehadir_session')); 
        if(s && s.date === new Date().toISOString().slice(0,10)) { 
            document.getElementById('defaultForm').classList.add('hidden-el'); 
            document.getElementById('dashboardPanel').classList.remove('hidden-el'); 
            document.getElementById('sessionName').innerText = s.nama; 
            triggerAlasanKeluar(); 
        } 
    }

    function loadList() { 
        if(document.getElementById('listContainer').children.length === 0 || document.getElementById('listContainer').innerText.includes("Memuatkan")) {
             document.getElementById('listContainer').innerHTML = '<div class="text-center py-4 text-slate-400"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
        }
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({action: "GET_LIST", passcode: PASSCODE}) })
        .then(r => r.json())
        .then(res => { 
            let l = res.data || res; 
            if(!Array.isArray(l)) l = [];
            
            // FILTER: Buang data jika ia datang dari sheet JAM (baris MASUK/KELUAR)
            // Kita tapis objek yang mempunyai nama 'MASUK' atau 'KELUAR'
            let filteredList = l.filter(i => {
                let nama = (i.nama || "").toUpperCase();
                return nama !== "MASUK" && nama !== "KELUAR";
            });

            document.getElementById('count').innerText = filteredList.length; 
            let h = ""; 
            
            if(filteredList.length === 0) {
                h = '<div class="text-center py-8 text-slate-400 text-xs border border-dashed border-slate-300 rounded-lg">Tiada rekod kehadiran.</div>';
            } else {
                filteredList.forEach(i => { 
                    let masaMasuk = i.jam || i.waktu || i.time || i.masa || '--:--';
                    let gambarUrl = i.gambar || i.image || i.url || i.foto || ''; 
                    let initial = i.nama ? i.nama.charAt(0).toUpperCase() : '?';
                    let isPelawat = i.kategori === 'PELAWAT';
                    let bgClass = isPelawat ? 'bg-slate-50 border-l-4 border-l-purple-500' : 'bg-white border-l-4 border-l-blue-500';

                    let durationStr = calcDuration(masaMasuk);
                    
                    let pelawatActions = '';
                    if(isPelawat) {
                        let imgBtn = gambarUrl ? 
                            `<button onclick="showImage('${gambarUrl}')" class="w-7 h-7 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 flex items-center justify-center transition shadow-sm"><i class="fa-regular fa-image"></i></button>` : 
                            `<span class="w-7 h-7 rounded-full bg-slate-100 text-slate-300 flex items-center justify-center"><i class="fa-solid fa-ban"></i></span>`;
                        
                        let delBtn = `<button onclick="forceCheckoutPelawat('${i.nama}')" class="w-7 h-7 rounded-full bg-red-100 text-red-600 hover:bg-red-200 flex items-center justify-center transition shadow-sm ml-1"><i class="fa-solid fa-xmark"></i></button>`;
                        
                        pelawatActions = `<div class="flex items-center mt-1">${imgBtn}${delBtn}</div>`;
                    }

                    h += `
                    <div class="${bgClass} p-3 rounded shadow-sm border border-slate-100 flex items-center justify-between">
                        <div class="flex items-center gap-3 w-full overflow-hidden">
                            <div class="flex-shrink-0 w-8 h-8 rounded bg-slate-100 text-slate-600 flex items-center justify-center text-xs font-bold">
                                ${initial}
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-bold text-slate-700 text-xs truncate uppercase">${i.nama}</h4>
                                <div class="flex items-center gap-2">
                                    <p class="text-[9px] text-slate-400 font-semibold uppercase tracking-wider">${i.kategori}</p>
                                    <span class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 rounded font-bold tracking-tight"><i class="fa-regular fa-clock mr-1"></i>${durationStr}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right pl-2 flex-shrink-0 flex flex-col items-end">
                            <span class="block text-xs font-bold text-slate-800 font-mono">${masaMasuk}</span>
                            ${pelawatActions}
                        </div>
                    </div>`; 
                }); 
            }
            document.getElementById('listContainer').innerHTML = h; 
        })
        .catch(err => {
            console.error(err);
            document.getElementById('listContainer').innerHTML = '<div class="text-center text-red-500 text-xs py-4">Ralat data.</div>';
        });
    }

    function processImage(i){if(i.files&&i.files[0]){let r=new FileReader();r.onload=function(e){let im=new Image();im.src=e.target.result;im.onload=function(){let cv=document.createElement("canvas");let ctx=cv.getContext("2d");cv.width=600;cv.height=600*(im.height/im.width);ctx.drawImage(im,0,0,cv.width,cv.height);let d=cv.toDataURL("image/jpeg",0.7);document.getElementById('previewImg').src=d;document.getElementById('previewImg').classList.remove('hidden-el');document.getElementById('placeholderCam').classList.add('hidden-el');document.getElementById('base64Foto').value=d;};};r.readAsDataURL(i.files[0]);}}
    function getHijriDate(){let t=new Date();let o={day:'numeric',month:'long',year:'numeric',calendar:'islamic-umalqura'};try{document.getElementById('hijriDisplay').innerHTML=`<i class="fa-regular fa-calendar-check mr-1"></i> ${new Intl.DateTimeFormat('ms-MY-u-ca-islamic-umalqura',o).format(t).replace('AH','').trim()}`;}catch(e){}}
    function checkKategori(){ if(document.getElementById('kategori').value==='PELAWAT') showPelawatForm(); }
    function showPelawatForm(){ document.getElementById('defaultForm').classList.add('hidden-el'); document.getElementById('dashboardPanel').classList.add('hidden-el'); document.getElementById('pelawatPanel').classList.remove('hidden-el'); }
    function cancelPelawat(){ document.getElementById('pelawatPanel').classList.add('hidden-el'); checkSession(); if(!localStorage.getItem('ehadir_session')) document.getElementById('defaultForm').classList.remove('hidden-el'); }
    function resetSesi(){ if(confirm("Reset sistem?")){localStorage.removeItem('ehadir_session');location.reload();} }
</script>
</body>
</html>