<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Hadir System</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: #2c3e50; color: #333; margin: 0; padding: 15px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: white; padding: 25px 20px; border-radius: 20px; width: 100%; max-width: 420px; text-align: center; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding-bottom: 40px; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; background: #f1f3f5; padding: 10px 15px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #1e3c72; }
        .clock { font-size: 1.4rem; font-weight: 800; color: #1e3c72; }
        .date { font-size: 0.85rem; font-weight: 600; color: #555; }
        h2 { margin-top: 0; color: #1e3c72; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; font-size: 1.5rem; }
        select, input, textarea { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ddd; border-radius: 12px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; font-family: inherit; }
        select:focus, input:focus { border-color: #1e3c72; outline: none; background: #f8f9ff; }
        
        /* ðŸ”¥ ASALNYA TERSEMBUNYI, AKAN MUNCUL GUNA JS ðŸ”¥ */
        textarea { resize: vertical; min-height: 80px; display: none; border: 2px solid #ff7675; }

        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.3s; text-transform: uppercase; margin-top: 10px; }
        .btn-masuk { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; box-shadow: 0 4px 15px rgba(30,60,114,0.3); }
        .btn-masuk:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        .btn-keluar { background: linear-gradient(135deg, #eb3b5a, #fc5c65); color: white; margin-top: 20px; }
        .status-tag { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; margin-top: 5px; }
        .status-online { background: #e3fcef; color: #00b894; }
        .status-offline { background: #ffeaa7; color: #d63031; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #1e3c72; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #gpsStatus { font-size: 0.8rem; font-weight: 600; margin-bottom: 15px; padding: 8px; border-radius: 8px; }
        .pelawat-panel { display: none; border: 2px dashed #1e3c72; padding: 15px; border-radius: 15px; margin-top: 15px; background: #f8f9ff; }
        #canvas { display: none; width: 100%; border-radius: 10px; margin-top: 10px; }
        #video { width: 100%; border-radius: 10px; background: #000; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <p style="font-weight: 800; margin-top: 15px; color: #1e3c72;">Sila Tunggu...</p>
</div>

<div class="container">
    <div id="connectionStatus" class="status-tag status-online" style="display:none;">ðŸ“¡ ONLINE</div>
    
    <div class="info-bar">
        <div style="text-align: left;">
            <div class="date" id="dateDisplay">--/--/----</div>
            <div class="date" id="hijriDisplay">-- Ramadan ----</div>
        </div>
        <div class="clock" id="clockDisplay">00:00:00</div>
    </div>

    <h2>E-Hadir SK Selama</h2>
    <div id="gpsStatus">Sedang mengesan lokasi...</div>

    <div id="defaultForm">
        <select id="kategori" onchange="checkKategori()">
            <option value="">-- PILIH KATEGORI --</option>
            <option value="GURU">GURU</option>
            <option value="AKP">AKP</option>
            <option value="KEBERSIHAN">PEKERJA KEBERSIHAN</option>
            <option value="PELAWAT">ðŸ”´ PELAWAT / KONTRAKTOR</option>
        </select>
        <input type="text" id="nama" placeholder="Nama Penuh (Huruf Besar)" oninput="this.value = this.value.toUpperCase()">
        
        <textarea id="alasanMasuk" placeholder="Sila nyatakan alasan LEWAT hadir..."></textarea>
        
        <button id="btnMasuk" class="btn-masuk" onclick="hantarMasuk()" disabled>Daftar Masuk</button>
    </div>

    <div id="pelawatPanel" class="pelawat-panel">
        <h3 style="margin-top:0">Borang Pelawat</h3>
        <input type="text" id="tujuan" placeholder="Tujuan / Jumpa Siapa">
        <input type="text" id="noPlat" placeholder="No. Plat Kenderaan">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <button onclick="tangkapGambar()" style="background:#00b894; color:white;">ðŸ“¸ Tangkap Gambar</button>
        <button onclick="hantarMasuk('PELAWAT')" class="btn-masuk" style="margin-top:10px;">Hantar Rekod Pelawat</button>
        <button onclick="batalPelawat()" style="background:#ccc; font-size:0.8rem;">Batal</button>
    </div>

    <div id="dashboardPanel" style="display:none;">
        <div style="background:#f1f3f5; padding:20px; border-radius:15px; margin-bottom:20px;">
            <p style="margin:0; font-size:0.9rem; font-weight:600;">Selamat Datang,</p>
            <h3 id="userNama" style="margin:5px 0; color:#1e3c72;">-</h3>
            <p id="userKategori" class="status-tag status-online">-</p>
        </div>
        
        <textarea id="alasanKeluar" placeholder="Sila nyatakan alasan BALIK AWAL..."></textarea>
        
        <button class="btn-keluar" onclick="hantarKeluar()">Daftar Keluar</button>
    </div>

    <p style="font-size: 0.7rem; color: #999; margin-top: 25px;">Versi 36.0 (Auto-Reason Logic) &copy; 2024</p>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyXACAxTAndTr91GvWM1_idtbkNYK4_aCNfz_rDpsX881nWy7bOMMWUcYPNHxHX-vE/exec"; // GANTI DENGAN URL WEB APP ANDA
    const PASSCODE = "101010";
    const SCHOOL_LAT = 5.12345; // Ganti dengan Latitud sekolah anda
    const SCHOOL_LNG = 100.12345; // Ganti dengan Longitud sekolah anda
    const ALLOWED_RADIUS = 1000; // 1km

    let userLocation = null;
    let fotoBase64 = "";
    let jamConfig = {};
    let offlineQueue = JSON.parse(localStorage.getItem('ehadir_offline_queue')) || [];

    window.onload = () => {
        startClock();
        checkExistingSesi();
        getLocation();
        fetchConfig();
        updateOnlineStatus();
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
    };

    function startClock() {
        setInterval(() => {
            let n = new Date();
            document.getElementById('clockDisplay').innerText = n.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('dateDisplay').innerText = n.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' });
            
            // Logik Automatik Alasan
            kemaskiniPaparanAlasan();
        }, 1000);
    }

    // LOGIK BARU: Tunjukkan kotak alasan hanya jika lewat/awal
    function kemaskiniPaparanAlasan() {
        let now = new Date();
        
        // 1. Semak Form Daftar Masuk
        let kat = document.getElementById('kategori').value;
        let boxMasuk = document.getElementById('alasanMasuk');
        if (kat && kat !== "PELAWAT" && jamConfig[kat]) {
            let limitMasuk = parseTime(jamConfig[kat].masuk, now);
            let limitKeluar = parseTime(jamConfig[kat].keluar, now);
            
            // Jika dah lepas waktu masuk DAN belum sampai waktu balik
            if (limitMasuk && limitKeluar && now > limitMasuk && now < limitKeluar) {
                boxMasuk.style.display = 'block';
            } else {
                boxMasuk.style.display = 'none';
            }
        }

        // 2. Semak Form Daftar Keluar
        let session = JSON.parse(localStorage.getItem('ehadir_session'));
        let boxKeluar = document.getElementById('alasanKeluar');
        if (session && jamConfig[session.kategori]) {
            let limitKeluar = parseTime(jamConfig[session.kategori].keluar, now);
            
            // Jika waktu sekarang masih awal dari waktu balik yang ditetapkan
            if (limitKeluar && now < limitKeluar) {
                boxKeluar.style.display = 'block';
            } else {
                boxKeluar.style.display = 'none';
            }
        }
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                userLocation = pos.coords;
                let dist = calculateDistance(SCHOOL_LAT, SCHOOL_LNG, pos.coords.latitude, pos.coords.longitude);
                let status = document.getElementById('gpsStatus');
                if (dist <= ALLOWED_RADIUS) {
                    status.innerHTML = "âœ… LOKASI DISAHKAN (DALAM KAWASAN)";
                    status.style.color = "#00b894";
                    document.getElementById('btnMasuk').disabled = false;
                } else {
                    status.innerHTML = "âŒ ANDA DI LUAR KAWASAN (" + Math.round(dist) + "m)";
                    status.style.color = "#d63031";
                    document.getElementById('btnMasuk').disabled = true;
                }
            }, err => {
                document.getElementById('gpsStatus').innerText = "âš ï¸ GPS ERROR: Sila aktifkan lokasi.";
            }, { enableHighAccuracy: true });
        }
    }

    function checkKategori() {
        let v = document.getElementById('kategori').value;
        if (v === 'PELAWAT') {
            showPelawatForm();
            document.getElementById('kategori').value = "";
        }
        kemaskiniPaparanAlasan();
    }

    function showPelawatForm() {
        document.getElementById('defaultForm').style.display = 'none';
        document.getElementById('pelawatPanel').style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
            document.getElementById('video').srcObject = s;
        });
    }

    function tangkapGambar() {
        let v = document.getElementById('video');
        let c = document.getElementById('canvas');
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        fotoBase64 = c.toDataURL('image/jpeg', 0.5);
        c.style.display = 'block';
        v.style.display = 'none';
    }

    function hantarMasuk(type = "") {
        let kat = type === "PELAWAT" ? "PELAWAT" : document.getElementById('kategori').value;
        let nama = document.getElementById('nama').value;
        let alasan = document.getElementById('alasanMasuk').value;
        
        if (!kat || !nama) return alert("Sila lengkapkan maklumat!");
        
        // Cek jika alasan wajib (jika kotak alasan sedang dipaparkan)
        if (document.getElementById('alasanMasuk').style.display === 'block' && !alasan) {
            return alert("Sila isi alasan lewat!");
        }

        let payload = {
            action: "MASUK",
            passcode: PASSCODE,
            kategori: kat,
            nama: nama,
            alasan: alasan,
            lat: userLocation ? userLocation.latitude : 0,
            lng: userLocation ? userLocation.longitude : 0,
            foto: fotoBase64,
            tujuan: document.getElementById('tujuan').value || "",
            noPlat: document.getElementById('noPlat').value || ""
        };

        prosesHantar(payload, () => {
            if (kat !== "PELAWAT") {
                localStorage.setItem('ehadir_session', JSON.stringify({ nama: nama, kategori: kat }));
                checkExistingSesi();
            } else {
                alert("Pendaftaran Pelawat Berjaya!");
                location.reload();
            }
        });
    }

    function hantarKeluar() {
        let session = JSON.parse(localStorage.getItem('ehadir_session'));
        let alasan = document.getElementById('alasanKeluar').value;

        // Cek jika alasan wajib (jika kotak alasan sedang dipaparkan)
        if (document.getElementById('alasanKeluar').style.display === 'block' && !alasan) {
            return alert("Sila isi alasan balik awal!");
        }

        let payload = {
            action: "KELUAR",
            passcode: PASSCODE,
            nama: session.nama,
            kategori: session.kategori,
            alasan: alasan,
            lat: userLocation ? userLocation.latitude : 0,
            lng: userLocation ? userLocation.longitude : 0
        };

        prosesHantar(payload, () => {
            localStorage.removeItem('ehadir_session');
            alert("Terima Kasih! Rekod Keluar Berjaya.");
            location.reload();
        });
    }

    function prosesHantar(payload, callback) {
        document.getElementById('loading').style.display = 'flex';
        if (!navigator.onLine) {
            offlineQueue.push(payload);
            localStorage.setItem('ehadir_offline_queue', JSON.stringify(offlineQueue));
            document.getElementById('loading').style.display = 'none';
            alert("Data disimpan (OFFLINE). Akan dihantar bila ada internet.");
            callback();
            return;
        }

        fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
        .then(r => r.json())
        .then(res => {
            document.getElementById('loading').style.display = 'none';
            if (res.status === "success") callback();
            else alert("Error: " + res.message);
        }).catch(e => {
            document.getElementById('loading').style.display = 'none';
            alert("Gagal menyambung ke server.");
        });
    }

    function checkExistingSesi() {
        let s = localStorage.getItem('ehadir_session');
        if (s) {
            let data = JSON.parse(s);
            document.getElementById('defaultForm').style.display = 'none';
            document.getElementById('dashboardPanel').style.display = 'block';
            document.getElementById('userNama').innerText = data.nama;
            document.getElementById('userKategori').innerText = data.kategori;
        }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        let R = 6371e3;
        let Ï†1 = lat1 * Math.PI/180;
        let Ï†2 = lat2 * Math.PI/180;
        let Î”Ï† = (lat2-lat1) * Math.PI/180;
        let Î”Î» = (lon2-lon1) * Math.PI/180;
        let a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function fetchConfig() {
        if(navigator.onLine) {
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_CONFIG", passcode: PASSCODE }) })
            .then(r => r.json())
            .then(d => { jamConfig = d; });
        }
    }

    function parseTime(t, refDate) {
        if (!t || t === "BEBAS") return null;
        let d = new Date(refDate);
        let p = t.match(/(\d+)[.:](\d+).*?(AM|PM)/i);
        if (p) {
            let h = parseInt(p[1]), m = parseInt(p[2]);
            if (p[3].toUpperCase() == "PM" && h < 12) h += 12;
            if (p[3].toUpperCase() == "AM" && h == 12) h = 0;
            d.setHours(h, m, 0, 0);
            return d;
        }
        return null;
    }

    function updateOnlineStatus() {
        let st = document.getElementById('connectionStatus');
        if (navigator.onLine) {
            st.style.display = "none";
            if (offlineQueue.length > 0) syncOfflineData();
        } else {
            st.innerText = "ðŸ“¡ TIADA INTERNET (MODE OFFLINE)";
            st.className = "status-tag status-offline";
            st.style.display = "block";
        }
    }

    function syncOfflineData() {
        let item = offlineQueue[0];
        fetch(API_URL, { method: "POST", body: JSON.stringify(item) })
        .then(r => r.json())
        .then(res => {
            if (res.status === "success") {
                offlineQueue.shift();
                localStorage.setItem('ehadir_offline_queue', JSON.stringify(offlineQueue));
                if (offlineQueue.length > 0) syncOfflineData();
                else alert("Semua data offline telah berjaya dihantar!");
            }
        });
    }

    function batalPelawat() {
        location.reload();
    }
</script>

</body>
</html>